//= require facebook_sdk
//= require state_cities
//= require_self
if(!olook) var olook = {};

olook.facebookCallbacks = function(){
  FB.Event.subscribe('auth.authResponseChange', function(response) {
  });
};

olook.sendFacebookUserInfo = function(user_info){
  var uuid = $('#qr_uuid').val();
  $.ajax({
    type: 'POST',
    url: '<%= Rails.application.routes.url_helpers.facebook_login_path %>',
    data: { qr_uuid: uuid, user: user_info },
    dataType: 'json'
  }).success(function(jdata){
    window.location = jdata.next_step;
  }).error(function(){
    //
  });
}

olook.getFBData = function(authResponse){
  var getData = function(){
    FB.api('/me', function(response) {
      var userData = {};
      userData.email = response.email;
      userData.first_name = response.first_name;
      userData.last_name = response.last_name;
      userData.uid = response.id;
      userData.facebookToken = authResponse.authResponse.accessToken;
      userData.gender = ( response.gender === 'male' ? '1' : '0' );
      var aux = response.birthday.split('/');
      userData.birthday = [ aux[1], aux[0], aux[2] ].join('/');
      olook.sendFacebookUserInfo(userData);
    });
  }
  FB.api('/me/permissions', function(response){
    if (response && response.data && response.data.length){
      var permissions = response.data.shift();
      if (permissions.email) {
        getData();
      } else {
        olook.FBNotAuthorized();
      }
    } else {
      olook.FBNotAuthorized();
    }
  });
};

olook.FBNotAuthorized = function(){};

olook.FBLogin = function() {
  FB.login(function(response){
    if (response.status === 'connected') {
      olook.getFBData(response);
    } else if (response.status === 'not_authorized') {
      olook.FBNotAuthorized();
    } else {
      // user canceled login
    }
  }, {scope: '<%= User::ALL_FACEBOOK_PERMISSIONS %>'});
}
olook.attachFBLogin = function(el) {
  $(el).click(function(e){
    e.preventDefault();
    FB.getLoginStatus(function(response) {
      if (response.status === 'connected') {
        olook.getFBData(response);
      } else if (response.status === 'not_authorized') {
        olook.FBLogin();
      } else {
        olook.FBLogin();
      }
    });
  });
}

$("#login").on("click", function(){
  content = $(".box-remember-login");
  o.newModal(content,360,490);
});
olook.load_state_cities = function(){
  new dgCidadesEstados({
    cidade: document.getElementById('user_city'),
    estado: document.getElementById('user_state')
  });
}

function applyCustomSelect(selector) {
  var its = $(selector);
  its.find('select').change(function(){
    var txt = $(this).find('option:selected').text();
    $(this).prev('p').text(txt);
  });
}
$(function(){
  if(user_has_errors) {
    content = $(".login_form");
    o.newModal(content);
  };
  olook.attachFBLogin('.fb_login_button');
  olook.load_state_cities();
  applyCustomSelect(".gender, .state, .city");
});

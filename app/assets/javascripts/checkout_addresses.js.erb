//= require state_cities
isJQueryLoaded = function() {
  return (typeof window.$ == 'function');
}

loadCepCheck = function() {
  $('.zip_code').change(function(){
    var cep = $(this).val().replace(/\D/, '');
    if(cep.length >= 8) {
      var url = '<%= Rails.application.routes.url_helpers.cep_path('__CEP__') %>';
      url = url.replace('__CEP__', cep);
      $.getJSON(url, function(data){
        $('#checkout_address_street').val(data.endereco);
        $('#checkout_address_neighborhood').val(data.bairro);
        // TODO: Usar a biblioteca de cidade e estado fode a porra toda
        $('#checkout_address_state').val(data.estado);
        setTimeout(function(){
          $('#checkout_address_city').val(data.cidade);
        }, 1000);
      });
    }

  });
}

loadStateAndCityCombobox = function() {
  if(!states_and_cities) var states_and_cities = {};

  states_and_cities.load_state_cities = function(){
    return new dgCidadesEstados({
      cidade: document.getElementById('checkout_address_city'),
      estado: document.getElementById('checkout_address_state')
    });
  }

  function changeTag(field){
    var txt = field.find(":selected").text();
    field.prev('p').text(" ").delay(100).text(txt);
  }

  $("#checkout_address_city").change(function(){
    changeTag($(this));
  });

  $("#checkout_address_state").change(function(){
    changeTag($(this));
    combo_service.run();
    changeTag($("#checkout_address_city"));
  });


  if(!combo_service) var combo_service = states_and_cities.load_state_cities();
}

if (isJQueryLoaded()) {
  loadStateAndCityCombobox();
  loadCepCheck();
} else {
  window.onload=function(){
    loadStateAndCityCombobox();
    loadCepCheck();
  }
}
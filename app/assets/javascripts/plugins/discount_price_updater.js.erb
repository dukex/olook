function DiscountPriceUpdater(opts) {
  this.product_ids = opts['product_ids'];
  this.prices = {};
  this.afterGetPricesSuccess = this.replaceUpdatedPrices;
}

DiscountPriceUpdater.prototype.getPrices = function() {
  $.ajax({
    url: '<%= Rails.application.routes.url_helpers.api_prices_path(format: 'json') %>',
    data: { product_ids: this.product_ids }
  }).success(function(data){
    this.prices = data['prices'];
    this.afterGetPricesSuccess();
  });
}

DiscountPriceUpdater.prototype.replaceUpdatedPrices = function() {
  for( var product_id in this.prices ) {
    var li = $('li[data-id="' + product_id + '"]');
    li.find('.price').remove();
    var html = '<%= render('shared/searched_product_discount_price', from: '__OLD__', to: '__NEW__') %>';
    var values = this.prices[product_id];
    li.find('.info-product').append(html.replace(/__OLD__/g, values['de']).replace(/__NEW__/g, values['por']));
  }
}

if(!olook) var olook = {};
olook.priceUpdater = function() {
  var product_ids = $('.product').map(function(idx, item){ return $(item).data('id'); });
  var dpu = new DiscountPriceUpdater({
    product_ids: product_ids
  });
  dpu.getPrices();
}

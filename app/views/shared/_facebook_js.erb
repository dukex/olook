<script type="text/javascript">
(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/all.js#xfbml=1&appId=<%= @facebook_app_id %>";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

</script>


<script type="text/javascript">

init_facebook = function (){
  window.fbAsyncInit = function(){
    FB.init({
      appId: '<%= facebook_app_id %>',
      status: true,
      cookie: true,
      oauth: true,
      xfbml: true,
      frictionlessRequests : true

    });

    FB.Event.subscribe('edge.create', function(href, widget) {

    <% if params[:controller] == "members" && params[:action] =="showroom" && params[:lbp] == "1" %>
      // A/B test rules:
      // if the user is
      // - accessing members#showroom and the lbp param is "1"
      // - clicking on a showroom product (which means that the "www.facebook.com/Olook" like link is excluded)
      // then the ClickFacebookLike event is going to be fired
      // for any other cases, the ClickFacebookLike is going to be fired
      // (if you re reading this, please ask someone if you can take out those rules, only firing the ClickFacebookLike for all cases)

      if( href == "www.facebook.com/Olook") {
        _gaq.push(['_trackEvent', 'Facebook', 'Like', href]);
      } else {
        _gaq.push(['_trackEvent', 'Showroom', 'ClickFacebookLike', href]);
      }
    <% else %>
      _gaq.push(['_trackEvent', 'Facebook', 'Like', href]);
    <% end %>
    });

    // FB.Event.subscribe('edge.create', function(href, widget) {
    //   _gaq.push(['_trackEvent', 'Showroom', 'ClickFacebookLike', '']);
    // });

    try {
      FB.XFBML.parse();
    } catch(ex){}

  }


  $("a.face-message").click(function(){
    if($("div.line.size ol").find("li input[type='radio']:checked").length > 0){
      FB.login(function(login_response) {
        if (login_response.authResponse) {
          getBoyfriendName();
        } else {
          console.log('User cancelled login or did not fully authorize.');
        }
      }, {scope: 'friends_birthday,publish_stream'});
    }
    else{
      showAlert();
    }
  });

  if($("#quick_view ul.social li.facebook").length > 0){
    $("#quick_view ul.social li.facebook a").click(function(){postProductToFacebookFeed()})
  }

}
window.addEventListener('load', init_facebook);

/**
  * TODO: Change the function name because we don't send message to boyfriend anymore
  *
  */
function getBoyfriendName(){
  FB.api('/me', function(response) {
    sendMessageToBoyfriend(response);
  });
}


function sendMessageToBoyfriend(me_response) {
  var boyfriend = "";
  var link_suffix = "?single=1";
  var size = $.trim($("div.line.size ol").find("li input[type='radio']:checked").prev().prev().text());
  var significant_other = me_response.significant_other;
  if(significant_other){
    boyfriend = significant_other.id;
    link_suffix = "";
  }

  ui_hash = {
    method: 'feed',
    name: 'Quero Olook de presente!',
    <% if @product %>
      caption: 'Vi este produto no site da Olook e amei! <3',
      to: me_response.id,
      display: "iframe",

      picture: 'http:'+'<%= @product.catalog_picture.to_s %>',
      description: 'Além de acertar em cheio no presente, a troca e devolução é grátis.',
      // link: '<%= "#{root_url}dia_dos_namorados/" %>'+me_response.id+'<%= "/#{@product.id.to_s}" %>'+link_suffix+'&size='+size
      link: '<%= "#{root_url}quero_ganhar/" %>'+me_response.id+'<%= "/#{@product.id.to_s}" %>'+link_suffix+'&size='+size
    <% end %>
  };

  function callback(response) {
    $(window).scrollTop($("#quick_view").position().top - 10)
  }

  FB.ui(ui_hash, callback);
}



function sendFacebookMessage() {
  FB.ui({
    method: 'send',
    caption: 'www.olook.com.br',
    picture: 'cdn.olook.com.br/assets/socialmedia/facebook/icon-app/app-2012-09-19.jpg',
    <% if member %>
      description: 'Tenho uma vitrine personalizada da Olook e recebo dicas das Stylists! Responda também, descubra seu estilo e tenha uma vitrine personalizada <%= accept_invitation_url(:invite_token => member.invite_token) %> #ficaadica',
      link: 'http://olook.com.br'
    <% else %>
      description: 'Tenho uma vitrine personalizada da Olook e recebo dicas das Stylists! Responda também, descubra seu estilo e tenha uma vitrine personalizada',
      link: '<%=  root_url %>'
    <% end %>
  });
}

function postToFacebookFeed() {
  var obj = {
method: 'feed',
    caption: 'www.olook.com.br',
    picture: 'cdn.olook.com.br/assets/socialmedia/facebook/icon-app/app-2012-09-19.jpg',
    <% if member %>
        link: '<%=  accept_invitation_url(:invite_token => member.invite_token) %>',
        description: 'Tenho uma vitrine personalizada da Olook e recebo dicas das Stylists! Responda também, descubra seu estilo e tenha uma vitrine personalizada <%= accept_invitation_url(:invite_token => member.invite_token) %> #ficaadica'
    <% else %>
      link: '<%=  root_url %>',
      description: 'Tenho uma vitrine personalizada da Olook e recebo dicas das Stylists! Responda também, descubra seu estilo e tenha uma vitrine personalizada <%= root_url %> #ficaadica'

    <% end %>
  };

  FB.ui(obj);
}

<% if defined?(product) && product.present? %>

function postProductToFacebookFeed() {
  var obj = {
    method: 'feed',
    caption: 'www.olook.com.br',
    link: '<%= request.host_with_port %>/produto/<%= product.id %>',
    picture: '<%= product.catalog_picture.to_s %>',
    description: '<%= share_description(product) %>'
  };

  FB.ui(obj);
}
<% end %>

</script>

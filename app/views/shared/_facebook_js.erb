<script type="text/javascript">
$(function(){
	window.fbAsyncInit = function(){
  	FB.init({
	    appId: '<%= facebook_app_id %>',
	    status: true,
	    cookie: true,
	    oauth: true,
      xfbml: true,
      frictionlessRequests : true
  
	  });

    
    FB.Event.subscribe('edge.create', function(href, widget) {
      _gaq.push(['_trackEvent', 'Facebook', 'Like', href]);      
    });

	  try {
	    FB.XFBML.parse();
	  } catch(ex){}
    
	}
  
  
  $("a.face-message").click(function(){
    if($("div.line.size ol").find("li input[type='radio']:checked").length > 0){    
      FB.login(function(login_response) {
        if (login_response.authResponse) {
          getBoyfriendName();
        } else {
          console.log('User cancelled login or did not fully authorize.');
        }
      }, {scope: 'friends_birthday,publish_stream,user_relationships,user_relationship_details'});
    }
    else{
      showAlert();
    }
  });
  
});


function getBoyfriendName(){
  FB.api('/me', function(response) {
    sendMessageToBoyfriend(response);
  });
}


function sendMessageToBoyfriend(me_response) {
  var boyfriend = "";
  var link_suffix = "?single=1";
  var size = $.trim($("div.line.size ol").find("li input[type='radio']:checked").prev().prev().text());
  var significant_other = me_response.significant_other;
  if(significant_other){
    boyfriend = significant_other.id;
    link_suffix = "";      
  }

  ui_hash = {
    method: 'feed',
    name: 'No Dia dos Namorados... Quero Olook de presente!',
    <% if @product %>
      caption: '<%= case @product.category
            when Category::SHOE 
              "Vi o sapato"
            when Category::BAG
              "Vi a bolsa"
            when Category::ACCESSORY
              "Vi o acessório"
            else            
              "Vi a roupa"            
            end %> <%= @product.name %> e amei! <3',
      to: boyfriend,
      display: "iframe",
    
      picture: '<%= @product.suggestion_picture.to_s %>',
      description: 'Comprando através deste link você terá 10% de desconto e embalagem de presente grátis. #ficaadica',
      link: '<%= "#{root_url}dia_dos_namorados/" %>'+me_response.id+'<%= "/#{@product.id.to_s}" %>'+link_suffix+'&size='+size
    <% end %>     
  }; 
  FB.ui(ui_hash);
}
 


function sendFacebookMessage() {
  FB.ui({
    method: 'send',
    caption: 'www.olook.com.br',
    picture: 'cdn.olook.com.br/assets/socialmedia/facebook/icon-app/app-2012-09-19.jpg',
    <% if member %>
      description: 'Tenho uma vitrine personaliza da olook e recebo recomendações das Stylists! Responda o style quiz, descubra o seu estilo e ganhe R$10! <%= accept_invitation_url(:invite_token => member.invite_token) %> #ficaadica',
      link: 'http://olook.com.br'
    <% else %>
      description: 'Tenho uma vitrine personaliza da olook e recebo recomendações das Stylists! Responda o style quiz, descubra o seu estilo e ganhe R$10!',
      link: '<%=  root_url %>'
    <% end %>   
  });
}

function postToFacebookFeed() {
  var obj = {
method: 'feed',
    caption: 'www.olook.com.br',
    picture: 'cdn.olook.com.br/assets/socialmedia/facebook/icon-app/app-2012-09-19.jpg',
    <% if member %>
        link: '<%=  accept_invitation_url(:invite_token => member.invite_token) %>',
        description: 'Tenho uma vitrine personalizada da olook e recebo recomendações incríveis das Stylists! Responda o style quiz, descubra o seu estilo e ganhe R$10! <%= accept_invitation_url(:invite_token => member.invite_token) %> #ficaadica'
    <% else %>
      link: '<%=  root_url %>',
      description: 'Tenho uma vitrine personalizada da olook e recebo recomendações incríveis das Stylists! Responda o style quiz, descubra o seu estilo e ganhe R$10! <%= root_url %> #ficaadica'

    <% end %>
  };

  FB.ui(obj);
}

(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/all.js#xfbml=1&appId=<%= @facebook_app_id %>";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

</script>


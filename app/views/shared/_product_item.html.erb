<%
  shoe_size = params[:shoe_sizes].to_a.find { |ss| !ss.blank? }.try(:to_i) || current_user.try(:shoes_size).try(:to_i)
%>
<li class="product<%= " promotion" if product.promotion? %>" data-id="<%= product.id %>">
  <%= render "shared/product_hover", :product => product, :gift => (gift ||= false), :shoe_size => (shoe_size ||= nil) %>
  <div class="box_product <%= quantity_status_moments(product, shoe_size) %>">
    <%= link_to product, :class => "product_link", :rel => "#{product.id}", :remote => (defined?(suggestion) || gift), :data => {:params => {:gift =>  (gift ||= false), :shoe_size => (shoe_size ||= nil)}} do %>
      <%= image_tag("common/ajax-loader-product.gif", :alt => product.name, :class => "async", data: { product: product.catalog_picture, backside: product.backside_picture, wearing: product.wearing_picture, showroom: ( product.send(image_method ||= :showroom_picture) || "fake/showroom-product.png" ) } ) %>

      <h1><p><span class="name"><%= product.formatted_name %></span></p></h1>
      <p class="warn sold_out"><b>ESGOTADO!</b></p>

      <% if shoe_size && product.shoe? %>
        <p class="warn quantity">SÃ³ mais <span><%= product.quantity( shoe_size ) %></span></p>
        <p class="warn shoe_size">Tam. <%= shoe_size %></p>
      <% end %>

      <% if product.promotion? && !product.sold_out? && product.discount_percent.to_i != 0 %>
        <p class="warn percentage"><span><%= product.discount_percent.to_i %>%</span><br />off</p>
      <% end %>
    <% end %>

    <div class="line">
      <%= link_to product, :class => "product_link", :rel => "#{product.id}", :remote => (defined?(suggestion) || gift), :data => {:params => {:gift =>  (gift ||= false), :shoe_size => (shoe_size ||= nil)}} do %>
        <p class="price brand"><b><%= show_brand_for product %></b></p>

        <p class="price">
          <% if product.promotion? %>
            <span class="old">De <%= number_to_currency product.price %></span>
            <span class="txt-pink">por <%= number_to_currency product.retail_price %></span>
          <% else %>
            <%= number_to_currency product.price %> ou <span class="plots"><%= installments(product.price) %></span>
          <% end %>
        </p>
      <%- end -%>

      <ol class="color_list">
        <% unless product.color_name.blank? %>
          <li>
            <%= link_to image_tag(product.color_sample.url || 'fake/no-color.png', :title => product.name), product, :'data-href' => "#{product.send(image_method ||= :showroom_picture) || 'fake/showroom-product.png'}", :class => "selected product_color"  %>
            <%= hidden_field_tag "product_id_#{product.id}", product.id, :class => "product_id" %>
            <% if current_user  && current_user.full_user? %>
              <%= hidden_field_tag "sold_out_#{product.id}", "#{( product.sold_out? || (product.quantity(current_user.shoes_size) == 0 && product.shoe?) ) ? 'sold_out' : ''}", :class => "sold_out" %>
              <%= hidden_field_tag "quantity_#{product.id}", "#{(current_user.shoes_size.nil?) ? '' : product.quantity( current_user.shoes_size )}", :class => "quantity" %>
            <% end %>
          </li>
        <% end %>
        <% product.colors(current_user.try(:shoes_size), !!current_admin).each do |related_product| %>
          <li>
            <%= link_to image_tag(related_product.color_sample.url || 'fake/no-color.png', :title => related_product.name), related_product, :'data-href' => "#{related_product.send(image_method ||= :showroom_picture) || 'fake/showroom-product.png'}", :class => "product_color", :data => {:params => {:gift =>  (gift ||= false), :shoe_size => (shoe_size ||= nil)}} %>
            <%= hidden_field_tag "product_id_#{related_product.id}", related_product.id, :class => "product_id" %>
            <% if current_user && current_user.full_user? %>
              <%= hidden_field_tag "sold_out_#{related_product.id}", "#{related_product.sold_out? || (related_product.quantity(current_user.shoes_size) == 0 && related_product.shoe?) ? 'sold_out' : ''}", :class => "sold_out" %>
              <%= hidden_field_tag "quantity_#{related_product.id}", "#{(current_user.shoes_size.nil?) ? '' : related_product.quantity( current_user.shoes_size )}", :class => "quantity" %>
            <% end %>
          </li>
        <% end %>
      </ol>
    </div>
  </div>
</li>

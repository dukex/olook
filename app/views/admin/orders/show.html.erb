<h2>Order <b><%= @order.number %></b></h2>

<div class="inner">
  <div class="inner_info" style='float:left;width:20%;'>
    <p>
      <b>Client:</b>
      <%= link_to "#{@order.user.name} - #{@order.user.email}", admin_user_path(@order.user) if @order.user %>
    </p>
    <p>
      <button style="padding:5px">
        <b><%= link_to 'Login', "/admin/users/login/#{@order.user.id}" if @order.user %><b>
      </button>
    </p>
    <p>
      <b>Date:</b>
      <%= l @order.created_at, :format => :short %>
    </p>
    <p>
      <b>Identification Code:</b>
      <%= @order.erp_payment ? @order.erp_payment.identification_code : "" %>
    </p>
    <p>
      <b>Moip ID:</b>
      <%= @order.erp_payment ? @order.erp_payment.try(:gateway_code) : "Pagamento não encontrado" %>
    </p>
    <p>
      <b>URL de Pagamento:</b>
      <%= @order.erp_payment ? link_to("Clique aqui para abrir a url de pagamento", @order.erp_payment.url) : "" %>
    </p>
    <p>
      <b>Status:</b>
      <%= @order.status %>
    </p>
    <p>
      <b>Payment method:</b>
      <% if @order.erp_payment %>
        <%= @order.erp_payment.human_to_s %> <%= "- #{@order.erp_payment.bank}" if @order.erp_payment.is_a? CreditCard %>
      <% else %>
        Pagamento não encontrado
      <% end %>
    </p>
    <p>
      <b>Products Total:</b>
      <%= number_to_currency(@order.subtotal) %>
    </p>
    <p>
      <b>Freight Total:</b>
      <%= number_to_currency(@order.freight_price) %>
    </p>
    <p>
      <b>Total Pago:</b>
      <%= number_to_currency(@order.amount_paid) %>
    </p>
    <p>
      <b>Installments:</b>
      <%= @order.installments %>x
    </p>
    <p>
      <b>Estimated delivery:</b>
      <%= @order.freight.delivery_time if @order.freight %> work days
    </p>

    <div>
      <h3>Cupons</h3>
      <% @order.payments.each do |payment| %>
        <p>
          <% if payment.coupon_id? %>
            <b><%= payment.coupon.code %></b>
            <b><%= number_to_currency(payment.coupon.value) %></b>
          <% end %>
        </p>
      <% end %>
    </div>

    <div>
      <h3>Endereço de entrega</h3>
        <% if @address %>
      <p><%= @address.identification  %></p>
      <p><%= "#{@address.street}, #{@address.number} - #{@address.neighborhood}" %></p>
      <p><%= "#{@address.zip_code}" %></p>
      <p><%= "#{@address.city}, #{@address.state}" %></p>
      <% end %>
    </div>
  </div>

  <%= render :partial => 'purchase_timeline', :locals => {:order => @order} %>

  <table class="table">
    <tr>
      <th></th>
      <th>SKU</th>
      <th>Product</th>
      <th>Quantity</th>
      <th>Unit Price</th>
      <th>Total</th>
      <th>Quantia a descontar em caso de estorno (Créditos de fidelidade)</th>
    </tr>

  <% credits = Credit.find_all_by_source_and_order_id("loyalty_program_credit",@order.id) 
  %>
  
  <% @order.line_items.each do |line_item| %>
    <tr>
      <td><%= image_tag(line_item.variant.thumb_picture) if line_item.variant.thumb_picture %></td>
      <td><%= link_to line_item.variant.sku, admin_product_path(line_item.variant.product) %></td>
      <td><%= link_to line_item.variant.name, admin_product_path(line_item.variant.product) %></td>
      <td><%= line_item.quantity  %></td>
      <td><%= number_to_currency(line_item.price) %></td>
      <td><%= number_to_currency(line_item.total_price) %></td>
      <td><%= number_to_currency(line_item.calculate_loyalty_credit_amount) %> 
        <%= "(utilizado ou estornado)" if (credits.first) && !credits.first.debits.empty? %>
      </td>   
    </tr>
  <% end %>
  </table>

  <h3>Total de Créditos de fidelidade</h3>
  <p><%= number_to_currency(@order.line_items.sum(&:calculate_loyalty_credit_amount)) %>  
     <%= link_to 'Remover créditos de fidelidade', admin_order_cancel_loyalty_credits_path(@order) if (credits.first) && credits.first.debits.empty?%>
     <%= "(Já utilizados ou estornados)" if (credits.first) && !credits.first.debits.empty? %>
  </p>

  <h3>Abacos</h3>
  <p>
    <b>Erp Integrate At:</b>
    <% if @order.erp_integrate_at %>
      <%= l @order.erp_integrate_at, :format => :short %>
    <% else %>
    Não ocorreu
    <% end %>
  </p>

  <p>
    <b>Erp Cancel At:</b>
    <% if @order.erp_cancel_at %>
    <%= l @order.erp_cancel_at, :format => :short %>
    <% else %>
    Não ocorreu
    <% end %>
  </p>

  <p>
    <b>Erp Payment At:</b>
    <% if @order.erp_payment_at %>
    <%= l @order.erp_payment_at, :format => :short %>
    <% else %>
    Não ocorreu
    <% end %>
  </p>

  <p>
    <b>Erp Integrate Error:</b>
    <%= @order.erp_integrate_error %>
  </p>
  <p>
    <b>Erp Cancel Error:</b>
    <%= @order.erp_cancel_error %>
  </p>
  <p>
    <b>Erp Payment Error:</b>
    <%= @order.erp_payment_error %>
  </p>

  <p>
    <h3><%= link_to 'Pagamentos', admin_payments_path(:search => {:order_id_eq => @order.id}) %></h3>
    <% @order.payments.each do |payment| %>
    <p>
      <b><%= link_to payment_with_origin(payment), admin_payment_path(payment) %>:</b>
      <%= number_to_currency payment.total_paid %> -
      <%= number_to_percentage payment.percent, :precision => 2 %>
    </p>
    <% end  %>
  </p>

  <p>
    <% if @order.state_events(guard: false).many? %>
    <%= form_tag(change_state_admin_order_path(@order)) do -%>
      <%= select_tag "event", options_from_collection_for_select(@order.state_events(guard: false).map(&:to_s), 'to_s','humanize') %>
      <%= submit_tag 'Change!' -%>
    <% end %>
    <% else %>
    Não há estados para a alteração.
    <% end %>
  </p>

</div>


<% content_for :secondary_navigation do %>
  <li><%= link_to 'Back', admin_orders_path %></li>
<% end %>

